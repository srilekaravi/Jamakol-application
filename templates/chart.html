<!DOCTYPE html>
<html lang="ta">
<head>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;600;700&display=swap" rel="stylesheet">

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>‡Æú‡Ææ‡Æ§‡Æï‡Æï‡Øç ‡Æï‡Æü‡Øç‡Æü‡ÆÆ‡Øç</title>
    <style>
        /* --- CORE RESETS --- */
        body {
            font-family: "Noto Sans Tamil", sans-serif;
            background: #fffef8;
            color: #222;
            margin: 0;
            padding: 10px;
            box-sizing: border-box;
            overflow-x: hidden; /* Prevent horizontal scroll */
        }

        *, *:before, *:after {
            box-sizing: border-box;
        }

        h2 {
            text-align: center;
            margin-bottom: 15px;
            font-size: 1.5rem;
        }
.site-header {
    display: flex;
    flex-direction: column;      /* ‚úÖ logo ‡ÆÆ‡Øá‡Æ≤, title ‡Æï‡ØÄ‡Æ¥ */
    align-items: center;         /* ‚úÖ horizontal center */
    justify-content: center;     /* ‚úÖ vertical center */
    text-align: center;
    padding: 15px;
}

/* Logo */
.logo {
    height: 70px;                /* desktop size */
    width: auto;
    margin-bottom: 6px;
}

/* Title */
.site-title {
    font-family: 'Cinzel', serif;   /* ‚úÖ new font */
    color: darkgreen;
    font-size: 32px;
    font-weight: 600;
    letter-spacing: 2px;
    white-space: nowrap;
}

        /* --- FORM BAR (RESPONSIVE) --- */
        #formbar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap; /* Allows items to drop to next line */
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            width: 100%;
        }

            #formbar input, #formbar select, #formbar textarea {
                padding: 6px 8px;
                font-size: 14px;
                border: 1px solid #ccc;
                border-radius: 4px;
            }

        /* Specific input sizing for desktop flow */
        #place {
            min-width: 200px;
        }

        #date {
            min-width: 130px;
        }

        #name {
            min-width: 150px;
        }

        /* Time wrapper to keep time/sec together */
        .time-group {
            display: flex;
            gap: 5px;
        }

        /* --- BUTTONS --- */
        button {
            background: #ff8800;
            color: white;
            border: none;
            padding: 6px 12px;
            font-size: 13px;
            border-radius: 4px;
            cursor: pointer;
            transition: 0.2s ease;
            white-space: nowrap; /* Prevents text breaking inside button */
        }

            button:hover {
                background: #e06f00;
                transform: scale(1.02);
            }

        #newChartBtn {
            background: #ff5722;
            font-weight: 600;
        }

            #newChartBtn:hover {
                background: #e64a19;
            }

        /* --- MAIN LAYOUT CONTAINER --- */
        #container {
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: flex-start;
            flex-wrap: wrap; /* CRITICAL: Allows stacking on tablets */
            width: 100%;
            max-width: 1600px;
            margin: 0 auto;
        }

        /* --- CHART STYLING (FLUID) --- */
        .chart-wrapper {
            position: relative;
            width: 100%;
            max-width: 600px; /* Max size for desktop */
            flex-shrink: 0;
        }

        #chart {
            width: 100%;
            /* Forces it to be a square based on width */
            aspect-ratio: 1 / 1;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 1px;
            border: 3px solid #000;
            background: #fff;
            margin: 0 auto;
        }

        .chart-box {
            border: 1px solid #000;
            padding: 2px;
            text-align: center;
            font-size: clamp(10px, 2.5vw, 14px); /* Dynamic font size */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            word-wrap: break-word;
        }

            .chart-box span {
                display: block;
                margin-bottom: 2px;
            }

            .chart-box small {
                display: block;
                margin-bottom: 2px;
                font-size: 0.85em;
            }

            .chart-box br {
                display: none;
            }

        #center-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: bold;
            color: darkgreen;
            font-size: clamp(16px, 4vw, 22px); /* Responsive font */
            pointer-events: none;
            transition: opacity 0.4s ease-in-out;
            background: rgba(255, 255, 255, 0.7);
            padding: 5px;
            border-radius: 4px;
        }

        /* --- SIDE PANELS (Tables, Dasha, Transit) --- */
        .side-panel {
            flex: 1;
            min-width: 300px; /* Don't get smaller than this */
            max-width: 520px; /* Don't get wider than this */
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* Tables */
        #planet-table {
            border-collapse: collapse;
            width: 100%; /* Fill the container */
            font-size: 13px;
            background: #fff;
        }

            #planet-table th, #planet-table td {
                border: 1px solid #999;
                padding: 4px;
                text-align: center;
            }

            #planet-table th {
                background: #ffb84d;
            }

        /* Panchangam & Dasha Boxes */
        .info-box {
            width: 100%;
            border: 1px solid #bbb;
            padding: 8px;
            border-radius: 6px;
            background: #fffef0;
            font-size: 13px;
            line-height: 1.4;
            color: #222;
            box-sizing: border-box;
            overflow-x: auto;
        }

        h4.panel-header {
            background: #ffb84d;
            color: #000;
            padding: 6px 8px;
            border-radius: 4px 4px 0 0;
            margin: 0;
            font-size: 14px;
            border: 1px solid #999;
            border-bottom: none;
        }

        /* Dasha Specifics */
        #dashaOuter {
            width: 100%;
        }

        #dashaBox {
            width: 100%;
            min-height: 220px;
            border: 2px solid #222;
            background: #fffef8;
            padding: 8px;
            border-radius: 8px;
            overflow: auto;
            position: relative;
        }

        /* Transit Panel */
        #transitPanel {
            width: 100%;
            display: none; /* Controlled by JS */
            flex-direction: column;
            gap: 10px;
        }

        /* --- MODAL --- */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 10px;
        }

        .modal-content {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            width: 100%;
            max-width: 500px; /* Default max width */
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

            .modal-content.wide {
                max-width: 900px;
            }
        .main-header {
    background: #ffffff;
    padding: 16px 24px;
    text-align: center;
    border-bottom: 2px solid #0b5c2d;
}

.logo-title {
    margin: 0;
    font-size: 34px;          /* increased size */
    font-weight: 700;
    color: #0b5c2d;            /* dark green */
    letter-spacing: 2px;
    text-transform: uppercase;
    font-family: "Poppins", "Segoe UI", sans-serif;
}
/* -------------------------------------------------- */
/* BASE / DESKTOP CHART LAYOUT (Desktop Default) */
/* -------------------------------------------------- */
#container {
    display: flex;
    justify-content: center;
    align-items: flex-start;
    gap: 20px;
    max-width: 1400px;
    margin: 0 auto;
}

/* Side panel widths for desktop */
#transitPanel, 
#tableWrapContainer, 
#dashaOuter {
    width: 20%; 
    flex-shrink: 0;
}

.chart-wrapper {
    width: 40%; 
    flex-shrink: 0;
}



/* Ensure the center tag is not forced to full width on desktop */
center {
    display: block; 
    padding: 10px 0;
}
/* -------------------------------------------------- */
/* MOBILE VIEW ONLY: Screens smaller than 768px */
/* (Dropdown/Controls, then Panchangam, then Chart, then Tables, then Dasha) */
/* -------------------------------------------------- */
@media (max-width: 768px) {
    
    /* 1. Stack the main container items vertically and remove internal gap */
    #container {
        flex-direction: column;
        align-items: center; 
        gap: 0 !important; /* Remove gap between stacked items */
        padding: 0 10px; 
    }

    /* 2. Dropdown Styling & Order (Must be FIRST - Assumed "formbar" equivalent) */
    center {
        width: 100%;
        padding: 10px 0; 
        order: -4; /* Ensures dropdown is 1st item */
        margin: 0 auto; 
    }
    
    #chartType2 {
        width: 60%; 
        display: block; 
        margin: 0 auto; 
        padding: 10px;
        box-sizing: border-box;
    }

    /* 3. Panchangam Display & Order (Must be SECOND - Below Dropdown/Controls) */
    #panchangamWrap {
        display: block !important; 
        width: 100%;
        padding: 10px 0; 
        box-sizing: border-box; 
        order: -3; /* Ensures it is the 2nd item (below the controls) */
        margin: 0; 
    }
    
    /* 4. Chart Display & Order (Must be THIRD) */
    .chart-wrapper {
        width: 100%; 
        order: -2; /* Ensures the chart is the 3rd item */
        margin-bottom: 0 !important; /* Remove gap after chart */
        padding: 10px 0; 
    }
    
    /* 5. Tables (tableWrapContainer) and Dasha full width, appear below chart/dropdown */
    /* Tables (Must be FOURTH) */
    #tableWrapContainer {
        width: 100%; 
        padding: 10px 0; 
        order: -1; /* Ensures tables are the 4th item */
        margin-bottom: 0 !important; 
    }

    /* Dasha (Must be FIFTH/LAST) */
    #dashaOuter {
        width: 100%; 
        padding: 10px 0; 
        order: 0; /* Ensures Dasha is the 5th/Last item in this group */
        margin: 0 !important; 
    }

    /* Ensure tables can scroll horizontally on small screens */
    #tableWrap {
        overflow-x: auto; 
        margin-bottom: 0 !important; 
    }
}

        /* --- MOBILE & TABLET ADAPTATIONS --- */

        /* Tablet/Small Laptop (Max width 1024px) */
        @media (max-width: 1024px) {
            #container {
                gap: 15px;
            }
  @media (max-width: 600px) {
    .logo {
        height: 50px;            /* mobile logo size */
    }

    .site-title {
        font-size: 20px;         /* mobile title size */
    }
}



            .side-panel {
                min-width: 100%; /* Stack fully on smaller tablets */
                max-width: 100%;
            }

            .chart-wrapper {
                max-width: 500px; /* Shrink chart slightly */
            }
        }

        /* Mobile (Max width 768px) and explicitly forced Mobile Mode */
        @media (max-width: 768px), body.mobile-test {
            body {
                padding: 5px;
            }

            h2 {
                font-size: 1.2rem;
                margin-bottom: 10px;
            }
            @media (max-width: 600px) {
    .logo-title {
        font-size: 24px;
        letter-spacing: 1px;
    }
}
@media (max-width: 600px) {
    .site-title {
        font-size: 20px;
        letter-spacing: 1px;
    }
}


            /* Form Grid Layout for Mobile */
            #formbar {
                display: grid !important;
                grid-template-columns: 1fr 1fr; /* 2 Columns */
                gap: 8px;
                width: 100%;
            }

            /* Make full width items in form */
            #name, #place, #comment, #tag, #gender, #chartType, #ayanamsa {
                grid-column: span 2; /* Take full width */
                width: 100%;
            }

            /* Group date and time on one row if possible, or stack */
            #date {
                grid-column: 1 / 2;
                width: 100%;
            }

            .time-group {
                grid-column: 2 / 3;
                width: 100%;
            }

                .time-group input {
                    width: 50%;
                }

            /* Buttons take full width or half */
            #formbar button {
                width: 100%;
                padding: 8px;
                height: auto;
            }

            /* Container Stack */
            #container {
                flex-direction: column;
                align-items: center;
                gap: 15px;
            }

            /* Chart fills width */
            .chart-wrapper {
                max-width: 100%;
                width: 96vw; /* Nearly full screen width */
            }

            #chart {
                border-width: 2px;
            }

            /* Center Label Adjustment */
            #center-label {
                font-size: 14px;
            }

            /* Panels */
            .side-panel {
                width: 100%;
                min-width: 0;
            }

            #dashaBox {
                min-height: 180px;
            }

            /* Modal Adjustments */
            .modal-content {
                width: 95%;
                padding: 15px;
            }
        }
        
    </style>
</head>
<body>
    <center>
 <header class="site-header">
    <img src="{{ url_for('static', filename='logo.png') }}" class="logo" alt="logo">
    <span class="site-title">SMV ASTRO RESEARCH</span>
</header>
    </center>
    <div id="formbar">
        <input id="name" list="nameList" placeholder="‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç">
        <datalist id="nameList"></datalist>
        
<input id="date" type="text" placeholder="DD/MM/YYYY" maxlength="10">


<input id="time" type="text" placeholder="HH:MM" maxlength="5">
<input id="date" type="date">
        <div class="time-group">
            <input id="time" type="time" step="1">
            <input id="seconds" type="number" min="0" max="59" value="0" placeholder="Sec">
        </div>
        
        <input id="place" list="placesList" placeholder="Type City (e.g. Chennai)..." autocomplete="off">
        <datalist id="placesList"></datalist>

        <select id="ayanamsa">
            <option value="lahiri">Lahiri</option>
            <option value="raman">Raman</option>
            <option value="kp">KP</option>
            <option value="yukteshwar">Yukteshwar</option>
        </select>

        <select id="chartType">
            <option value="rasi">‡Æ∞‡Ææ‡Æö‡Æø</option>
            <option value="bhava">Bhava Chart</option>
            <option value="d9">D9 - ‡Æ®‡Æµ‡ÆÆ‡Øç‡Æö‡ÆÆ‡Øç</option>
            
        </select>

        <select id="gender">
            <option value="">‡Æ™‡Ææ‡Æ≤‡Æø‡Æ©‡ÆÆ‡Øç (Gender)</option>
            <option value="Male">‡ÆÜ‡Æ£‡Øç (Male)</option>
            <option value="Female">‡Æ™‡ØÜ‡Æ£‡Øç (Female)</option>
            <option value="Other">‡ÆÆ‡Æ±‡Øç‡Æ±‡Æµ‡Øà (Other)</option>
        </select>

        <select id="tag">
            <option value="">‡Æµ‡Æï‡Øà (Tag)</option>
            <option value="Client">‡Æµ‡Ææ‡Æü‡Æø‡Æï‡Øç‡Æï‡Øà‡ÆØ‡Ææ‡Æ≥‡Æ∞‡Øç (Client)</option>
            <option value="Family">‡Æï‡ØÅ‡Æü‡ØÅ‡ÆÆ‡Øç‡Æ™‡ÆÆ‡Øç (Family)</option>
            <option value="Friend">‡Æ®‡Æ£‡Øç‡Æ™‡Æ∞‡Øç (Friend)</option>
            <option value="Other">‡ÆÆ‡Æ±‡Øç‡Æ±‡Æµ‡Øà (Other)</option>
        </select>

        <textarea id="comment" rows="2" placeholder="‡Æï‡ØÅ‡Æ±‡Æø‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Æ≥‡Øç / Notes (optional)" style="grid-column: span 2; width: 100%;"></textarea>

        <button onclick="openAddPlace()">+ Add Place</button>
        <button onclick="saveChart()">üíæ Save</button>
        <button onclick="openSavedCharts()">üìÇ View Saved</button>
        <button id="newChartBtn">‚ûï New Chart</button>
        <button id="toggleTransitBtn">ü™ê ‡Æï‡Øã‡Æü‡Øç‡Æö‡Ææ‡Æ∞ ‡Æï‡Æø‡Æ∞‡Æï‡Æ®‡Æø‡Æ≤‡Øà‡Æï‡Æ≥‡Øç</button>
        <button id="clientNotesBtn">üóí Client Notes</button>
    </div>

    <center>
        <select id="chartType2">
            <option value="rasi">‡Æ∞‡Ææ‡Æö‡Æø</option>
            <option value="bhava">Bhava Chart</option>
            <option value="d9">D9 - ‡Æ®‡Æµ‡ÆÆ‡Øç‡Æö‡ÆÆ‡Øç</option>
            <option value="all16" style="font-weight: bold; color: rgb(69, 39, 160);">üî¢ All 16 Divisions</option>
        </select>
    </center>
    <script>
document.addEventListener("DOMContentLoaded", () => {
    const c1 = document.getElementById("chartType");      // main selector
    const c2 = document.getElementById("chartType2");     // center selector

    if (!c1 || !c2) return;

    // When main dropdown changes ‚Üí update center one
    c1.addEventListener("change", () => {
        c2.value = c1.value;
        generateChart();
    });

    // When center dropdown changes ‚Üí update main one
    c2.addEventListener("change", () => {
        c1.value = c2.value;
        generateChart();
    });
});
    </script>

    <div id="container">

        <div id="transitPanel" class="side-panel" style="display:none;">
            <div id="currentTransitArea">
                <div id="transitBox" class="info-box"></div>
            </div>
            <aside id="transitHistory" class="info-box">
                <h4>üìú Transit History</h4>
                <div id="transitHistoryList"></div>
            </aside>
        </div>

        <div id="tableWrapContainer" class="side-panel">
            <div id="tableWrap" style="width:100%; overflow-x:auto;"></div>

            <div id="panchangamWrap" style="display:none; width: 100%;">
                <h4 class="panel-header">ü™î ‡Æ™‡Æû‡Øç‡Æö‡Ææ‡Æô‡Øç‡Æï‡ÆÆ‡Øç</h4>
                <div id="panchangamData" class="info-box">
                </div>
            </div>
        </div>

        <div class="chart-wrapper">
            <div id="chart"></div>
            <div id="center-label">‡Æ∞‡Ææ‡Æö‡Æø</div>
        </div>

        <div id="dashaOuter" class="side-panel">
            <div id="dashaBox">
                <div style="font-weight:bold; margin-bottom:4px;">ü™î Vimshottari Dasha</div>
                <div id="dashaTreeWrap" style="font-size:13px; line-height:1.3; color:#222;">(loading...)</div>
            </div>
        </div>
    </div>

    <div class="modal" id="savedModal">
        <div class="modal-content wide">
            <button onclick="closeModal('savedModal')"
                    style="position:absolute; top:8px; right:8px; background:#f44336; color:#fff;
                    border:none; border-radius:50%; width:28px; height:28px;
                    font-size:16px; cursor:pointer; line-height:1;">
                x
            </button>

            <h3 style="margin-top:0;">üìÅ ‡Æö‡Øá‡ÆÆ‡Æø‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü ‡Æú‡Ææ‡Æ§‡Æï‡Æô‡Øç‡Æï‡Æ≥‡Øç</h3>
            <input type="text" id="savedSearch"
                   placeholder="üîç ‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç / ID / ‡Æï‡ØÅ‡Æ±‡Æø‡Æ™‡Øç‡Æ™‡ØÅ ‡Æ§‡Øá‡Æü‡ØÅ..."
                   style="width:100%; padding:8px; margin-bottom:8px; box-sizing:border-box;" />
            <div id="savedList" style="overflow-x:auto; max-height: 60vh;">Loading...</div>
            <div style="margin-top:8px; text-align:right;">
                <button onclick="closeModal('savedModal')">Close</button>
            </div>
        </div>
    </div>

    <div class="modal" id="addPlaceModal">
        <div class="modal-content">
            <h3>‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ ‡Æá‡Æü‡ÆÆ‡Øç ‡Æö‡Øá‡Æ∞‡Øç‡Æï‡Øç‡Æï</h3>
            <input id="pCity" placeholder="City" style="width:100%; margin-bottom:5px; padding:6px;"><br>
            <input id="pState" placeholder="State" style="width:100%; margin-bottom:5px; padding:6px;"><br>
            <input id="pCountry" placeholder="Country" style="width:100%; margin-bottom:5px; padding:6px;"><br>
            <input id="pLat" placeholder="Latitude" style="width:100%; margin-bottom:5px; padding:6px;"><br>
            <input id="pLon" placeholder="Longitude" style="width:100%; margin-bottom:5px; padding:6px;"><br>
            <input id="pTz" placeholder="Timezone (e.g., 5.5)" style="width:100%; margin-bottom:5px; padding:6px;"><br><br>
            <button onclick="addPlace()">Save Place</button>
            <button onclick="closeModal('addPlaceModal')">Cancel</button>
        </div>
    </div>

    <script>
        const DEFAULT_PLACE = { city: "Chennai", lat: 13.0827, lon: 80.2707, tz: 5.5 };
        const planetColors = {
            "‡Æö‡ØÇ‡Æ∞‡Æø‡ÆØ‡Æ©‡Øç": "#e67e22", "‡Æö‡Æ®‡Øç‡Æ§‡Æø‡Æ∞‡Æ©‡Øç": "#3498db", "‡Æö‡ØÜ‡Æµ‡Øç‡Æµ‡Ææ‡ÆØ‡Øç": "#ff4d4d",
            "‡Æ™‡ØÅ‡Æ§‡Æ©‡Øç": "#27ae60", "‡Æï‡ØÅ‡Æ∞‡ØÅ": "#f1c40f", "‡Æö‡ØÅ‡Æï‡Øç‡Æï‡Æø‡Æ∞‡Æ©‡Øç": "#f78fb3",
            "‡Æö‡Æ©‡Æø": "#2c3e50", "‡Æ∞‡Ææ‡Æï‡ØÅ": "#8e44ad", "‡Æï‡Øá‡Æ§‡ØÅ": "#95a5a6",
            "‡ÆÆ‡Ææ‡Æ®‡Øç‡Æ§‡Æø": "#34495e", "‡Æ≤‡Æï‡Øç‡Æ©‡ÆÆ‡Øç": "#ff7f00"
        };

        async function loadPlaces() {
            const res = await fetch("/list_places");
            const places = await res.json();

            let input = document.getElementById("placeSearch");
            if (!input) {
                input = document.createElement("input");
                input.id = "placeSearch";
                input.setAttribute("list", "placesList");
                input.setAttribute("placeholder", "Type city name...");
                input.style.width = "100%";
                // Ensure styles match new CSS
                input.style.padding = "6px 8px";
                input.style.border = "1px solid #ccc";
                input.style.borderRadius = "4px";
            }

            let dataList = document.getElementById("placesList");
            if (!dataList) {
                dataList = document.createElement("datalist");
                dataList.id = "placesList";
                document.body.appendChild(dataList);
            }
            dataList.innerHTML = "";

            places.forEach(p => {
                const opt = document.createElement("option");
                opt.value = `${p.city_en} / ${p.city}`;
                opt.setAttribute("data-lat", p.lat);
                opt.setAttribute("data-lon", p.lon);
                opt.setAttribute("data-tz", p.tz);
                dataList.appendChild(opt);
            });

            const sel = document.getElementById("place");
            if (sel && !document.getElementById("placeSearch")) {
                sel.parentNode.replaceChild(input, sel);
            }

            input.value = "Chennai / ‡Æö‡ØÜ‡Æ©‡Øç‡Æ©‡Øà";
            const match = [...dataList.options].find(o => o.value.startsWith("Chennai"));
            if (match) {
                input.setAttribute("data-lat", match.getAttribute("data-lat"));
                input.setAttribute("data-lon", match.getAttribute("data-lon"));
                input.setAttribute("data-tz", match.getAttribute("data-tz"));
            }

            input.addEventListener("input", e => {
                const val = e.target.value;
                const match = [...dataList.options].find(o =>
                    o.value.toLowerCase().startsWith(val.toLowerCase())
                );
                if (match) {
                    input.setAttribute("data-lat", match.getAttribute("data-lat"));
                    input.setAttribute("data-lon", match.getAttribute("data-lon"));
                    input.setAttribute("data-tz", match.getAttribute("data-tz"));
                    generateChart();
                }
            });

            generateChart();
        }

        function addAutoUpdateListeners() {
            const ids = ["date", "time", "seconds", "ayanamsa", "chartType", "placeSearch"];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener("change", generateChart);
                    el.addEventListener("input", generateChart);
                }
            });
        }

        window.addEventListener("load", () => {
            loadPlaces();
            addAutoUpdateListeners();
            const now = new Date();
            document.getElementById("date").value = now.toISOString().slice(0, 10);
            document.getElementById("time").value = now.toTimeString().slice(0, 8);
            document.getElementById("seconds").value = now.getSeconds();
        });

        function generateChart() {
            const dateVal = document.getElementById("date").value;
            const timeVal = document.getElementById("time").value;
            const seconds = parseInt(document.getElementById("seconds").value || 0);
            const placeInput = document.getElementById("placeSearch");
            const place = {
                lat: parseFloat(placeInput.getAttribute("data-lat")) || DEFAULT_PLACE.lat,
                lon: parseFloat(placeInput.getAttribute("data-lon")) || DEFAULT_PLACE.lon,
                tz: parseFloat(placeInput.getAttribute("data-tz")) || DEFAULT_PLACE.tz
            };
            const ayanamsa = document.getElementById("ayanamsa").value;
            const chartType = document.getElementById("chartType").value;

            if (!dateVal) return;

            const [year, month, day] = dateVal.split("-").map(x => parseInt(x));
            const [hour, minute] = timeVal.split(":").map(x => parseInt(x));
            const payload = {
                year, month, day, hour, minute, second: seconds,
                lat: place.lat, lon: place.lon, tz: place.tz,
                ayanamsa, chartType
            };

            if (chartType === "bhava") {
                fetch("/bhava_chart", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                })
                .then(r => r.json())
                .then(res => {
                    if (res.status === "ok") {
                        if (typeof renderBhavaChart === "function") {
                            renderBhavaChart(res);
                        } else {
                            console.error("renderBhavaChart not found!");
                        }
                        document.getElementById("tableWrap").innerHTML = "<h4>Bhava Chart</h4>";
                    }
                });
                return;
            }

            fetch("/generate_chart", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            }).then(r => r.json()).then(res => {
                if (res.status === "ok") {
                    renderChart(res.rows);
                    const labelMap = {
                        rasi: "ü™ê Rasi Chart Planets",
                        d9: "ü™ê Navamsa (D9) Planets",
                        d10: "ü™ê Dasamsa (D10) Planets",
                        d7: "ü™ê Saptamsa (D7) Planets"
                    };
                    document.getElementById("tableWrap").innerHTML =
                        `<h4>${labelMap[chartType] || "Planets"}</h4>` + res.html;
                    updateCenterLabel();
                }
            });
        }

        function renderChart(rows) {
            const tamilRasis = ["‡ÆÆ‡Øá‡Æ∑‡ÆÆ‡Øç", "‡Æ∞‡Æø‡Æ∑‡Æ™‡ÆÆ‡Øç", "‡ÆÆ‡Æø‡Æ§‡ØÅ‡Æ©‡ÆÆ‡Øç", "‡Æï‡Æü‡Æï‡ÆÆ‡Øç", "‡Æö‡Æø‡ÆÆ‡Øç‡ÆÆ‡ÆÆ‡Øç", "‡Æï‡Æ©‡Øç‡Æ©‡Æø",
                "‡Æ§‡ØÅ‡Æ≤‡Ææ‡ÆÆ‡Øç", "‡Æµ‡Æø‡Æ∞‡ØÅ‡Æö‡Øç‡Æö‡Æø‡Æï‡ÆÆ‡Øç", "‡Æ§‡Æ©‡ØÅ‡Æö‡ØÅ", "‡ÆÆ‡Æï‡Æ∞‡ÆÆ‡Øç", "‡Æï‡ØÅ‡ÆÆ‡Øç‡Æ™‡ÆÆ‡Øç", "‡ÆÆ‡ØÄ‡Æ©‡ÆÆ‡Øç"];
            const grid = {}; tamilRasis.forEach(r => grid[r] = []);
            let lagnaRasi = null;

            rows.forEach(r => {
                if (!r.name || r.name === "‡Æ∞‡Ææ‡Æö‡Æø") return;
                const rasi = r.rasi || "";
                if (!rasi || !grid.hasOwnProperty(rasi)) return;

                const color = planetColors[r.name] || "#000";
                if (r.name === "‡Æ≤‡Æï‡Øç‡Æ©‡ÆÆ‡Øç") lagnaRasi = rasi;
                const label = r.grid_label || `(${r.name})`;
                let shortDeg = "";
                if (r.dms) {
                    let match = r.dms.match(/(\d+)[¬∞:] ?(\d+)/);
                    if (match) {
                        const d = match[1];
                        const m = match[2];
                        shortDeg = `${d}¬∞${m}'`;
                    } else if (typeof r.dms === "string" && r.dms.trim() !== "") {
                        shortDeg = r.dms.replace(/[^\d¬∞‚Ä≤]/g, "").slice(0, 6);
                    }
                }

                grid[rasi].push(
                    `<span style='color:${color};font-weight:bold;'>${label}</span>` +
                    (shortDeg ? `<small>${shortDeg}</small>` : "")
                );
            });

            const order = ["‡ÆÆ‡ØÄ‡Æ©‡ÆÆ‡Øç", "‡ÆÆ‡Øá‡Æ∑‡ÆÆ‡Øç", "‡Æ∞‡Æø‡Æ∑‡Æ™‡ÆÆ‡Øç", "‡ÆÆ‡Æø‡Æ§‡ØÅ‡Æ©‡ÆÆ‡Øç",
                "‡Æï‡ØÅ‡ÆÆ‡Øç‡Æ™‡ÆÆ‡Øç", null, null, "‡Æï‡Æü‡Æï‡ÆÆ‡Øç",
                "‡ÆÆ‡Æï‡Æ∞‡ÆÆ‡Øç", null, null, "‡Æö‡Æø‡ÆÆ‡Øç‡ÆÆ‡ÆÆ‡Øç",
                "‡Æ§‡Æ©‡ØÅ‡Æö‡ØÅ", "‡Æµ‡Æø‡Æ∞‡ØÅ‡Æö‡Øç‡Æö‡Æø‡Æï‡ÆÆ‡Øç", "‡Æ§‡ØÅ‡Æ≤‡Ææ‡ÆÆ‡Øç", "‡Æï‡Æ©‡Øç‡Æ©‡Æø"];

            const chart = document.getElementById("chart");
            chart.innerHTML = "";
            order.forEach(r => {
                if (r === null) chart.innerHTML += "<div></div>";
                else {
                    const hl = (r === lagnaRasi);
                    chart.innerHTML += `<div class='chart-box' style='background:${hl ? "#fff8e1" : "#fff"}; border-color:${hl ? "#ff9800" : "#000"};'>${grid[r].join("<br>")}</div>`;
                }
            });
        }

        function updateCenterLabel() {
            const type = document.getElementById("chartType").value;
            const label = document.getElementById("center-label");
            if (!label) return;
            label.style.opacity = "0";
            setTimeout(() => {
                switch (type) {
                    case "rasi": label.textContent = "‡Æ∞‡Ææ‡Æö‡Æø"; break;
                    case "d9": label.textContent = "‡Æ®‡Æµ‡ÆÆ‡Øç‡Æö‡ÆÆ‡Øç (D9)"; break;
                    case "d10": label.textContent = "‡Æ§‡Æö‡ÆÆ‡Øç‡Æö‡ÆÆ‡Øç (D10)"; break;
                    case "d7": label.textContent = "‡Æ∏‡Æ™‡Øç‡Æ§‡ÆÆ‡Øç‡Æö‡ÆÆ‡Øç (D7)"; break;
                    case "bhava": label.textContent = "‡Æ∏‡Øç‡Æ∞‡ØÄ‡Æ™‡Æ§‡Æø ‡Æ™‡Ææ‡Æµ‡ÆÆ‡Øç"; break;
                }
                label.style.opacity = "1";
            }, 300);
        }

        let currentEditingId = null;

        function openSavedCharts() {
            fetch("/list_charts")
                .then(r => r.json())
                .then(list => {
                    if (!Array.isArray(list) || list.length === 0) {
                        document.getElementById("savedList").innerHTML = "<p>‚ö†Ô∏è No saved charts found.</p>";
                        document.getElementById("savedModal").style.display = "flex";
                        return;
                    }
                    let html = `<table style="width:100%; border-collapse:collapse; min-width:400px;">
                        <tr style="background:#f0f0f0; text-align:left;">
                            <th style="padding:5px; border:1px solid #ccc;">ID</th>
                            <th style="padding:5px; border:1px solid #ccc;">‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç</th>
                            <th style="padding:5px; border:1px solid #ccc;">‡Æ™‡Æø‡Æ±‡Æ®‡Øç‡Æ§ ‡Æ§‡Øá‡Æ§‡Æø</th>
                            <th style="padding:5px; border:1px solid #ccc;">‡Æï‡ØÅ‡Æ±‡Æø‡Æ™‡Øç‡Æ™‡ØÅ</th>
                            <th style="padding:5px; border:1px solid #ccc;">‡Æö‡ØÜ‡ÆØ‡Æ≤‡Øç‡Æï‡Æ≥‡Øç</th>
                        </tr>`;
                    list.forEach(r => {
                        html += `<tr>
                            <td style="padding:5px; border:1px solid #ccc;">${r.id}</td>
                            <td style="padding:5px; border:1px solid #ccc;">${r.name || ""}</td>
                            <td style="padding:5px; border:1px solid #ccc;">${r.date || ""}</td>
                            <td style="padding:5px; border:1px solid #ccc;">${r.comment || "-"}</td>
                            <td style="padding:5px; border:1px solid #ccc;">
                                <button onclick="loadSavedChart(${r.id})">üìÑ Load</button>
                                <button onclick="deleteSavedChart(${r.id})">üóëÔ∏è Del</button>
                            </td>
                        </tr>`;
                    });
                    html += "</table>";
                    document.getElementById("savedList").innerHTML = html;
                    document.getElementById("savedModal").style.display = "flex";
                });
        }

        function loadSavedChart(cid) {
            fetch(`/get_chart/${cid}`)
                .then(r => r.json())
                .then(async res => {
                    if (res.status !== "ok" || !res.chart) {
                        alert("Chart not found.");
                        return;
                    }
                    const chart = res.chart;
                    currentEditingId = chart.id;
                    window.currentChartId = cid;

                    document.getElementById("name").value = chart.name || "";
                    document.getElementById("date").value = chart.date || "";
                    document.getElementById("time").value = chart.time || "";
                    if (chart.gender) document.getElementById("gender").value = chart.gender;
                    if (chart.tag) document.getElementById("tag").value = chart.tag;
                    if (chart.comment) document.getElementById("comment").value = chart.comment;

                    const pj = chart.place_json || {};
                    const placeField = document.getElementById("placeSearch") || document.getElementById("place");
                    if (placeField) {
                        placeField.value = pj.city || "";
                        placeField.setAttribute("data-lat", pj.lat || 13.0827);
                        placeField.setAttribute("data-lon", pj.lon || 80.2707);
                        placeField.setAttribute("data-tz", pj.tz || 5.5);
                    }

                    window.lastChartData = chart.data_json || {};
                    generateChart();

                    await renderClientNotes(window.currentChartId);
                    renderTransitVersionsList(window.currentChartId);
                    loadTransitHistory(window.currentChartId);
                    loadTransitHistoryMini(window.currentChartId);

                    saveCurrentTransitSnapshot(cid);
                    closeModal("savedModal");
                    alert(`‚úÖ Loaded chart #${chart.id} (${chart.name})`);
                });
        }

        function saveChart() {
            try {
                const name = document.getElementById("name").value.trim();
                const date = document.getElementById("date").value;
                const time = document.getElementById("time").value;
                const seconds = document.getElementById("seconds").value || 0;

                if (!name || !date || !time) {
                    alert("‚ö†Ô∏è Please fill Name, Date and Time.");
                    return;
                }

                const placeInput = document.getElementById("placeSearch") || document.getElementById("place");
                if (!placeInput) {
                    alert("‚ö†Ô∏è Please select a valid place.");
                    return;
                }

                const selectedPlace = {
                    city: placeInput.value || "",
                    lat: placeInput.getAttribute("data-lat") || DEFAULT_PLACE.lat,
                    lon: placeInput.getAttribute("data-lon") || DEFAULT_PLACE.lon,
                    tz: placeInput.getAttribute("data-tz") || DEFAULT_PLACE.tz
                };

                const ayanamsa = document.getElementById("ayanamsa").value;
                const chartType = document.getElementById("chartType").value;
                const gender = document.getElementById("gender") ? document.getElementById("gender").value : "";
                const tag = document.getElementById("tag") ? document.getElementById("tag").value : "";
                const comment = document.getElementById("comment") ? document.getElementById("comment").value : "";

                const payload = {
                    id: currentEditingId || null,
                    name, date, time, seconds,
                    place_json: selectedPlace,
                    ayanamsa, chartType,
                    gender, tag, comment,
                    data_json: window.lastChartData || {}
                };

                fetch("/update_chart_full", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                })
                .then(r => r.json())
                .then(d => {
                    if (d.status === "ok") {
                        alert(currentEditingId ? "‚úÖ Updated!" : "üíæ Saved!");
                        if (d.id) {
                            currentEditingId = d.id;
                            window.currentChartId = d.id;
                        }
                    } else {
                        alert("‚ùå Save failed: " + d.message);
                    }
                });

            } catch (e) {
                console.error("Save error:", e);
                alert("‚ùå Unexpected error.");
            }
        }

        function deleteSavedChart(cid) {
            if (!confirm("Are you sure?")) return;
            fetch(`/delete_chart/${cid}`, { method: "POST" })
                .then(r => r.json())
                .then(d => {
                    if (d.status === "ok") {
                        alert("üóëÔ∏è Deleted.");
                        openSavedCharts();
                    } else {
                        alert("‚ùå Failed.");
                    }
                });
        }

        function addPlace() { /* ... */ }
        function closeModal(id) { document.getElementById(id).style.display = "none"; }
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const addVersionBtn = document.getElementById("createTransitVersionBtn");
            if (addVersionBtn) {
                addVersionBtn.addEventListener("click", () => {
                    if (window.currentChartId) createNewTransitVersion(window.currentChartId);
                    else alert("Open a chart first.");
                });
            }
        });
    </script>

    <script src="/static/js/rasiChart.js"></script>
    <script src="/static/js/core.js"></script>
    <script src="/static/js/panchangam.js"></script>
    <script src="/static/js/transit.js"></script>
    <script src="/static/js/transit_history.js"></script>
    <script src="/static/js/vimshottari.js"></script>
    <script src="/static/js/event_summary.js"></script>
    <script src="/static/js/ashtakavarga.js"></script>
    <script src="/static/js/shadbala.js"></script>
    <script src="/static/js/bhava.js?v=2"></script>
    <script src="/static/js/kp.js"></script>
    <script src="/static/js/padas.js"></script>
    <script src="/static/js/karakas.js"></script>
    <script src="/static/js/comparison.js"></script>
    <script src="/static/js/all_divisions.js"></script>
    <script>
        window.addEventListener('load', function () {
            const btn = document.getElementById('clientNotesBtn');
            if (!btn) return;
            btn.addEventListener('click', function () {
                if (typeof window.toggleClientNotes === 'function') window.toggleClientNotes();
                else if (typeof window.renderClientNotes === 'function') window.renderClientNotes();
                else console.error('Client Notes module not ready');
            });
        });
    </script>

    <script>
    document.addEventListener("DOMContentLoaded", function() {
        // Function to make an element draggable via Touch
        function addTouchSupport(elmnt) {
            var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            var header = elmnt.querySelector(".notepad-header") || elmnt.querySelector("h4") || elmnt;

            if(header) {
                header.addEventListener("touchstart", dragTouchStart, {passive: false});
            }

            function dragTouchStart(e) {
                var touch = e.touches[0];
                pos3 = touch.clientX;
                pos4 = touch.clientY;
                document.addEventListener("touchend", closeDragElement, {passive: false});
                document.addEventListener("touchmove", elementDrag, {passive: false});
            }

            function elementDrag(e) {
                var touch = e.touches[0];
                e.preventDefault();
                pos1 = pos3 - touch.clientX;
                pos2 = pos4 - touch.clientY;
                pos3 = touch.clientX;
                pos4 = touch.clientY;
                elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
                elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
            }

            function closeDragElement() {
                document.removeEventListener("touchend", closeDragElement);
                document.removeEventListener("touchmove", elementDrag);
            }
        }

        var existingModals = document.querySelectorAll('.draggable-modal, [id$="Panel"], [id$="Notepad"]');
        existingModals.forEach(m => addTouchSupport(m));

        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                mutation.addedNodes.forEach((node) => {
                    if (node.nodeType === 1) {
                        if (node.classList.contains('draggable-modal') ||
                            node.style.position === 'absolute' ||
                            node.querySelector('.notepad-header')) {
                            addTouchSupport(node);
                        }
                    }
                });
            });
        });

        observer.observe(document.body, { childList: true, subtree: true });
    });
    </script>
    <script>
    document.getElementById("mobileTestBtn").addEventListener("click", function () {
        document.body.classList.toggle("mobile-test");

        if (document.body.classList.contains("mobile-test")) {
            this.textContent = "üñ• Back to Desktop";
        } else {
            this.textContent = "üì± Mobile Preview";
        }
    });
    </script>


</body>
</html>


































