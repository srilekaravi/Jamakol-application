<!DOCTYPE html>
<html lang="ta">
<head>
  <meta charset="utf-8">
  <title>роЬро╛родроХроХрпН роХроЯрпНроЯроорпН</title>
  <style>
    body {
      font-family: "Noto Sans Tamil", sans-serif;
      background: #fffef8;
      color: #222;
      margin: 0;
      padding: 10px;
    }

    h2 {
      text-align: center;
      margin-bottom: 10px;
    }

    #formbar {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 10px;
    }

    #formbar input, #formbar select {
      padding: 4px 6px;
      font-size: 13px;
    }

    #place {
      min-width: 220px;
    }

    button {
      background: #ff9800;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
    }

    button:hover {
      background: #e68900;
    }

    #container {
      display: flex;
      gap: 20px;
      justify-content: center;
      align-items: flex-start;
    }

    #chart {
      width: 600px;
      height: 600px;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      grid-template-rows: repeat(4, 1fr);
      gap: 2px;
      border: 3px solid #000;
      background: #fff;
      position: relative;
    }

    .chart-box {
      border: 1px solid #000;
      border-radius: 6px;
      padding: 6px;
      text-align: center;
      font-size: 14px;
    }

    #planet-table {
      border-collapse: collapse;
      width: 420px;
      font-size: 13px;
    }

    #planet-table th, #planet-table td {
      border: 1px solid #999;
      padding: 4px;
      text-align: center;
    }

    #planet-table th {
      background: #ffb84d;
    }

    #center-label {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-weight: bold;
      color: darkgreen;
      font-size: 22px;
      pointer-events: none;
      transition: opacity 0.4s ease-in-out;
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.4);
      display: none;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      width: 420px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal h3 { margin-top: 0; }

    .modal table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .modal th, .modal td {
      border: 1px solid #ccc;
      padding: 4px;
      text-align: center;
    }

    .modal button { margin: 3px; }
  </style>
</head>
<body>

  <h2>роЬро╛родроХроХрпН роХроЯрпНроЯроорпН (South Indian Style)</h2>

  <div id="formbar">
    <input id="name" type="text" placeholder="рокрпЖропро░рпН">
    <input id="date" type="date">
    <div>
      <input id="time" type="time" step="1">
      <input id="seconds" type="number" min="0" max="59" value="0" style="width:50px;">
    </div>
    <select id="place"></select>
    <select id="ayanamsa">
      <option value="lahiri">Lahiri</option>
      <option value="raman">Raman</option>
      <option value="kp">KP</option>
      <option value="yukteshwar">Yukteshwar</option>
    </select>
    <select id="chartType">
      <option value="rasi">ро░ро╛роЪро┐</option>
      <option value="d9">D9 - роиро╡роорпНроЪроорпН</option>
      <option value="d10">D10 - родроЪроорпНроЪроорпН</option>
      <option value="d7">D7 - ро╕рокрпНродроорпНроЪроорпН</option>
    </select>
    <button onclick="openAddPlace()">+ Add Place</button>
    <button onclick="saveChart()">ЁЯТ╛ Save</button>
    <button onclick="openSavedCharts()">ЁЯУВ View Saved</button>
  </div>

  <div id="container">
    <div style="position: relative;">
      <div id="chart"></div>
      <div id="center-label">ро░ро╛роЪро┐</div>
    </div>
    <div id="tableWrap"></div>
  </div>

  <!-- Saved Charts Modal -->
  <div class="modal" id="savedModal">
    <div class="modal-content">
      <h3>роЪрпЗрооро┐роХрпНроХрокрпНрокроЯрпНроЯ роЬро╛родроХроЩрпНроХро│рпН</h3>
      <div id="savedList">Loading...</div>
      <button onclick="closeModal('savedModal')">Close</button>
    </div>
  </div>

  <!-- Add Place Modal -->
  <div class="modal" id="addPlaceModal">
    <div class="modal-content">
      <h3>рокрпБродро┐роп роЗроЯроорпН роЪрпЗро░рпНроХрпНроХ</h3>
      <input id="pCity" placeholder="City"><br>
      <input id="pState" placeholder="State"><br>
      <input id="pCountry" placeholder="Country"><br>
      <input id="pLat" placeholder="Latitude"><br>
      <input id="pLon" placeholder="Longitude"><br>
      <input id="pTz" placeholder="Timezone (e.g., 5.5)"><br><br>
      <button onclick="addPlace()">Save Place</button>
      <button onclick="closeModal('addPlaceModal')">Cancel</button>
    </div>
  </div>

  <script>
    const DEFAULT_PLACE = { city: "Chennai", lat: 13.0827, lon: 80.2707, tz: 5.5 };
    const planetColors = {
      "роЪрпВро░ро┐ропройрпН": "#e67e22", "роЪроирпНродро┐ро░ройрпН": "#3498db", "роЪрпЖро╡рпНро╡ро╛ропрпН": "#ff4d4d",
      "рокрпБродройрпН": "#27ae60", "роХрпБро░рпБ": "#f1c40f", "роЪрпБроХрпНроХро┐ро░ройрпН": "#f78fb3",
      "роЪройро┐": "#2c3e50", "ро░ро╛роХрпБ": "#8e44ad", "роХрпЗродрпБ": "#95a5a6",
      "рооро╛роирпНродро┐": "#34495e", "ро▓роХрпНройроорпН": "#ff7f00"
    };

    async function loadPlaces() {
      const res = await fetch("/list_places");
      const places = await res.json();
      const sel = document.getElementById("place");
      sel.innerHTML = "";
      places.forEach(p => {
        const opt = document.createElement("option");
        opt.value = JSON.stringify(p);
        opt.textContent = `${p.city}, ${p.country}`;
        sel.appendChild(opt);
      });
      const chn = [...sel.options].find(o => o.textContent.startsWith("Chennai"));
      if (chn) sel.value = chn.value;
    }

    function addAutoUpdateListeners() {
      ["date", "time", "seconds", "ayanamsa", "chartType", "place"].forEach(id => {
        document.getElementById(id).addEventListener("change", generateChart);
      });
    }

    window.addEventListener("load", () => {
      loadPlaces();
      addAutoUpdateListeners();
      const now = new Date();
      document.getElementById("date").value = now.toISOString().slice(0, 10);
      document.getElementById("time").value = now.toTimeString().slice(0, 8);
      document.getElementById("seconds").value = now.getSeconds();
      generateChart();
    });

    function generateChart() {
      const dateVal = document.getElementById("date").value;
      const timeVal = document.getElementById("time").value;
      const seconds = parseInt(document.getElementById("seconds").value || 0);
      const place = JSON.parse(document.getElementById("place").value || "{}");
      const ayanamsa = document.getElementById("ayanamsa").value;
      const chartType = document.getElementById("chartType").value;
      if (!dateVal) return;

      const [year, month, day] = dateVal.split("-").map(x => parseInt(x));
      const [hour, minute] = timeVal.split(":").map(x => parseInt(x));
      const payload = {
        year, month, day, hour, minute, second: seconds,
        lat: place.lat || DEFAULT_PLACE.lat,
        lon: place.lon || DEFAULT_PLACE.lon,
        tz: place.tz || DEFAULT_PLACE.tz,
        ayanamsa, chartType
      };

      fetch("/generate_chart", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      }).then(r => r.json()).then(res => {
        if (res.status === "ok") {
          renderChart(res.rows);
          const labelMap = {
            rasi: "ЁЯкР Rasi Chart Planets",
            d9: "ЁЯкР Navamsa (D9) Planets",
            d10: "ЁЯкР Dasamsa (D10) Planets",
            d7: "ЁЯкР Saptamsa (D7) Planets"
          };
          document.getElementById("tableWrap").innerHTML = `<h4>${labelMap[chartType]}</h4>` + res.html;
          updateCenterLabel();
        }
      });
    }

    function renderChart(rows) {
      const tamilRasis = ["роорпЗро╖роорпН", "ро░ро┐ро╖рокроорпН", "рооро┐родрпБройроорпН", "роХроЯроХроорпН", "роЪро┐роорпНроороорпН", "роХройрпНройро┐",
        "родрпБро▓ро╛роорпН", "ро╡ро┐ро░рпБроЪрпНроЪро┐роХроорпН", "родройрпБроЪрпБ", "роороХро░роорпН", "роХрпБроорпНрокроорпН", "роорпАройроорпН"];
      const grid = {}; tamilRasis.forEach(r => grid[r] = []);
      let lagnaRasi = null;
      rows.forEach(r => {
        if (!r.name || r.name === "ро░ро╛роЪро┐") return;
        const color = planetColors[r.name] || "#000";
        if (r.name === "ро▓роХрпНройроорпН") lagnaRasi = r.rasi;
        const [d, m] = r.dms.split(":");
        const short = `${d}┬░${m}'`;
        grid[r.rasi].push(`<span style='color:${color};font-weight:bold;'>${r.name}</span><small>${short}</small>`);
      });
      const order = ["роорпАройроорпН", "роорпЗро╖роорпН", "ро░ро┐ро╖рокроорпН", "рооро┐родрпБройроорпН",
        "роХрпБроорпНрокроорпН", null, null, "роХроЯроХроорпН",
        "роороХро░роорпН", null, null, "роЪро┐роорпНроороорпН",
        "родройрпБроЪрпБ", "ро╡ро┐ро░рпБроЪрпНроЪро┐роХроорпН", "родрпБро▓ро╛роорпН", "роХройрпНройро┐"];
      const chart = document.getElementById("chart");
      chart.innerHTML = "";
      order.forEach(r => {
        if (r === null) chart.innerHTML += "<div></div>";
        else {
          const hl = (r === lagnaRasi);
          chart.innerHTML += `<div class='chart-box' style='background:${hl ? "#fff8e1" : "#fff"};border-color:${hl ? "#ff9800" : "#000"};'>${grid[r].join("<br>")}</div>`;
        }
      });
    }

    function updateCenterLabel() {
      const type = document.getElementById("chartType").value;
      const label = document.getElementById("center-label");
      label.style.opacity = "0";
      setTimeout(() => {
        switch (type) {
          case "rasi": label.textContent = "ро░ро╛роЪро┐"; break;
          case "d9": label.textContent = "роиро╡роорпНроЪроорпН (D9)"; break;
          case "d10": label.textContent = "родроЪроорпНроЪроорпН (D10)"; break;
          case "d7": label.textContent = "ро╕рокрпНродроорпНроЪроорпН (D7)"; break;
        }
        label.style.opacity = "1";
      }, 300);
    }

    // Save, view, delete, comment & add place (same as before)
    function saveChart() { /* ... keep previous save logic ... */ }
    function openSavedCharts() { /* ... keep previous list logic ... */ }
    function addPlace() { /* ... same ... */ }
    function closeModal(id) { document.getElementById(id).style.display = "none"; }
  </script>
</body>
</html>
