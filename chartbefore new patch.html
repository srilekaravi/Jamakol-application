<!DOCTYPE html>
<html lang="ta">
<head>
    <meta charset="utf-8">
    <title>ஜாதகக் கட்டம்</title>
    <style>
        body {
            font-family: "Noto Sans Tamil", sans-serif;
            background: #fffef8;
            color: #222;
            margin: 0;
            padding: 10px;
        }

        h2 {
            text-align: center;
            margin-bottom: 10px;
        }

        #formbar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 10px;
        }

            #formbar input, #formbar select {
                padding: 4px 6px;
                font-size: 13px;
            }

        #place {
            min-width: 220px;
        }

        button {
            background: #ff9800;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

            button:hover {
                background: #e68900;
            }

        #container {
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: flex-start;
        }

        #chart {
            width: 600px;
            height: 600px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 2px;
            border: 3px solid #000;
            background: #fff;
            position: relative;
        }

        .chart-box {
            border: 1px solid #000;
            border-radius: 6px;
            padding: 6px;
            text-align: center;
            font-size: 14px;
        }

        #planet-table {
            border-collapse: collapse;
            width: 420px;
            font-size: 13px;
        }

            #planet-table th, #planet-table td {
                border: 1px solid #999;
                padding: 4px;
                text-align: center;
            }

            #planet-table th {
                background: #ffb84d;
            }

        #center-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: bold;
            color: darkgreen;
            font-size: 22px;
            pointer-events: none;
            transition: opacity 0.4s ease-in-out;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.4);
            display: none;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            width: 420px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal h3 {
            margin-top: 0;
        }

        .modal table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .modal th, .modal td {
            border: 1px solid #ccc;
            padding: 4px;
            text-align: center;
        }

        .modal button {
            margin: 3px;
        }
    </style>
</head>
<body>

    <h2>ஜாதகக் கட்டம் (South Indian Style)</h2>

    <div id="formbar">
        <input id="name" type="text" placeholder="பெயர்">
        <input id="date" type="date">
        <div>
            <input id="time" type="time" step="1">
            <input id="seconds" type="number" min="0" max="59" value="0" style="width:50px;">
        </div>
        <select id="place"></select>
        <select id="ayanamsa">
            <option value="lahiri">Lahiri</option>
            <option value="raman">Raman</option>
            <option value="kp">KP</option>
            <option value="yukteshwar">Yukteshwar</option>
        </select>
        <select id="chartType">
            <option value="rasi">ராசி</option>
            <option value="d9">D9 - நவம்சம்</option>
            <option value="d10">D10 - தசம்சம்</option>
            <option value="d7">D7 - ஸப்தம்சம்</option>
        </select>
        <!-- 🆕 Optional extra fields -->
        <select id="gender">
            <option value="">பாலினம் (Gender)</option>
            <option value="Male">ஆண் (Male)</option>
            <option value="Female">பெண் (Female)</option>
            <option value="Other">மற்றவை (Other)</option>
        </select>

        <select id="tag">
            <option value="">வகை (Tag)</option>
            <option value="Client">வாடிக்கையாளர் (Client)</option>
            <option value="Family">குடும்பம் (Family)</option>
            <option value="Friend">நண்பர் (Friend)</option>
            <option value="Other">மற்றவை (Other)</option>
        </select>

        <textarea id="comment" rows="2" placeholder="குறிப்புகள் / Notes (optional)"></textarea>

        <button onclick="openAddPlace()">+ Add Place</button>
        <button onclick="saveChart()">💾 Save</button>
        <button onclick="openSavedCharts()">📂 View Saved</button>
    </div>

    <div id="container">
        <div style="position: relative;">
            <div id="chart"></div>
            <div id="center-label">ராசி</div>
        </div>
        <div id="tableWrap"></div>

<!-- 🪔 Panchangam Section -->
<div id="panchangamWrap" style="margin-top:10px;padding:10px;border:1px solid #ddd;border-radius:8px;background:#fff8e1;display:none;">
<h4 style="margin:0 0 6px 0;">🪔 பஞ்சாங்கம்</h4>
<div id="panchangamData" style="font-size:14px;line-height:1.6;">Loading...</div>
</div>

    </div>

    <!-- Saved Charts Modal -->
    <div class="modal" id="savedModal">
        <div class="modal-content">
            <h3>சேமிக்கப்பட்ட ஜாதகங்கள்</h3>
            <div id="savedList">Loading...</div>
            <button onclick="closeModal('savedModal')">Close</button>
        </div>
    </div>

    <!-- Add Place Modal -->
    <div class="modal" id="addPlaceModal">
        <div class="modal-content">
            <h3>புதிய இடம் சேர்க்க</h3>
            <input id="pCity" placeholder="City"><br>
            <input id="pState" placeholder="State"><br>
            <input id="pCountry" placeholder="Country"><br>
            <input id="pLat" placeholder="Latitude"><br>
            <input id="pLon" placeholder="Longitude"><br>
            <input id="pTz" placeholder="Timezone (e.g., 5.5)"><br><br>
            <button onclick="addPlace()">Save Place</button>
            <button onclick="closeModal('addPlaceModal')">Cancel</button>
        </div>
    </div>

    <script>
        const DEFAULT_PLACE = { city: "Chennai", lat: 13.0827, lon: 80.2707, tz: 5.5 };
        const planetColors = {
            "சூரியன்": "#e67e22", "சந்திரன்": "#3498db", "செவ்வாய்": "#ff4d4d",
            "புதன்": "#27ae60", "குரு": "#f1c40f", "சுக்கிரன்": "#f78fb3",
            "சனி": "#2c3e50", "ராகு": "#8e44ad", "கேது": "#95a5a6",
            "மாந்தி": "#34495e", "லக்னம்": "#ff7f00"
        };

        async function loadPlaces() {
            const res = await fetch("/list_places");
            const places = await res.json();

            // Build or reuse datalist
            let input = document.getElementById("placeSearch");
            if (!input) {
                input = document.createElement("input");
                input.id = "placeSearch";
                input.setAttribute("list", "placesList");
                input.setAttribute("placeholder", "Type city name...");
                input.style.width = "200px";
            }

            let dataList = document.getElementById("placesList");
            if (!dataList) {
                dataList = document.createElement("datalist");
                dataList.id = "placesList";
                document.body.appendChild(dataList);
            }
            dataList.innerHTML = "";

            places.forEach(p => {
                const opt = document.createElement("option");
                opt.value = `${p.city_en} / ${p.city}`;
                opt.setAttribute("data-lat", p.lat);
                opt.setAttribute("data-lon", p.lon);
                opt.setAttribute("data-tz", p.tz);
                dataList.appendChild(opt);
            });

            // Replace #place only once
            const sel = document.getElementById("place");
            if (sel && !document.getElementById("placeSearch")) {
                sel.parentNode.replaceChild(input, sel);
            }

            // Auto-fill default Chennai if found
            input.value = "Chennai / சென்னை";
            const match = [...dataList.options].find(o => o.value.startsWith("Chennai"));
            if (match) {
                input.setAttribute("data-lat", match.getAttribute("data-lat"));
                input.setAttribute("data-lon", match.getAttribute("data-lon"));
                input.setAttribute("data-tz", match.getAttribute("data-tz"));
            }

            // Trigger chart immediately and when typing
            input.addEventListener("input", e => {
                const val = e.target.value;
                const match = [...dataList.options].find(o =>
                    o.value.toLowerCase().startsWith(val.toLowerCase())
                );
                if (match) {
                    input.setAttribute("data-lat", match.getAttribute("data-lat"));
                    input.setAttribute("data-lon", match.getAttribute("data-lon"));
                    input.setAttribute("data-tz", match.getAttribute("data-tz"));
                    generateChart();
                }
            });

            generateChart();
        }

        function addAutoUpdateListeners() {
            const ids = ["date", "time", "seconds", "ayanamsa", "chartType", "placeSearch"];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener("change", generateChart);
                    el.addEventListener("input", generateChart);
                }
            });
        }

        window.addEventListener("load", () => {
            loadPlaces();
            addAutoUpdateListeners();
            const now = new Date();
            document.getElementById("date").value = now.toISOString().slice(0, 10);
            document.getElementById("time").value = now.toTimeString().slice(0, 8);
            document.getElementById("seconds").value = now.getSeconds();
        });

        function generateChart() {
            const dateVal = document.getElementById("date").value;
            const timeVal = document.getElementById("time").value;
            const seconds = parseInt(document.getElementById("seconds").value || 0);
            const placeInput = document.getElementById("placeSearch");
            const place = {
                lat: parseFloat(placeInput.getAttribute("data-lat")) || DEFAULT_PLACE.lat,
                lon: parseFloat(placeInput.getAttribute("data-lon")) || DEFAULT_PLACE.lon,
                tz: parseFloat(placeInput.getAttribute("data-tz")) || DEFAULT_PLACE.tz
            };
            const ayanamsa = document.getElementById("ayanamsa").value;
            const chartType = document.getElementById("chartType").value;
            if (!dateVal) return;

            const [year, month, day] = dateVal.split("-").map(x => parseInt(x));
            const [hour, minute] = timeVal.split(":").map(x => parseInt(x));
            const payload = {
                year, month, day, hour, minute, second: seconds,
                lat: place.lat, lon: place.lon, tz: place.tz,
                ayanamsa, chartType
            };

            fetch("/generate_chart", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            }).then(r => r.json()).then(res => {
                if (res.status === "ok") {
                    renderChart(res.rows);
                    const labelMap = {
                        rasi: "🪐 Rasi Chart Planets",
                        d9: "🪐 Navamsa (D9) Planets",
                        d10: "🪐 Dasamsa (D10) Planets",
                        d7: "🪐 Saptamsa (D7) Planets"
                    };
                    document.getElementById("tableWrap").innerHTML =
                        `<h4>${labelMap[chartType]}</h4>` + res.html;
                    updateCenterLabel();
                }
            });
        }

        function renderChart(rows) {
            const tamilRasis = ["மேஷம்", "ரிஷபம்", "மிதுனம்", "கடகம்", "சிம்மம்", "கன்னி",
                "துலாம்", "விருச்சிகம்", "தனுசு", "மகரம்", "கும்பம்", "மீனம்"];
            const grid = {}; tamilRasis.forEach(r => grid[r] = []);
            let lagnaRasi = null;

            rows.forEach(r => {
                if (!r.name || r.name === "ராசி") return;
                const color = planetColors[r.name] || "#000";
                if (r.name === "லக்னம்") lagnaRasi = r.rasi;
                const label = r.grid_label || `(${r.name})`;
                let shortDeg = "";
                if (r.dms && r.dms.includes(":")) {
                    const [d, m] = r.dms.split(":");
                    shortDeg = `${parseInt(d)}°${parseInt(m)}'`;
                }
                grid[r.rasi].push(
                    `<span style='color:${color};font-weight:bold;'>${label}</span>` +
                    (shortDeg ? `<small>${shortDeg}</small>` : "")
                );
            });

            const order = ["மீனம்", "மேஷம்", "ரிஷபம்", "மிதுனம்",
                "கும்பம்", null, null, "கடகம்",
                "மகரம்", null, null, "சிம்மம்",
                "தனுசு", "விருச்சிகம்", "துலாம்", "கன்னி"];

            const chart = document.getElementById("chart");
            chart.innerHTML = "";
            order.forEach(r => {
                if (r === null) chart.innerHTML += "<div></div>";
                else {
                    const hl = (r === lagnaRasi);
                    chart.innerHTML += `
                    <div class='chart-box'
                         style='background:${hl ? "#fff8e1" : "#fff"};
                                border-color:${hl ? "#ff9800" : "#000"};'>
                        ${grid[r].join("<br>")}
                    </div>`;
                }
            });
        }

        function updateCenterLabel() {
            const type = document.getElementById("chartType").value;
            const label = document.getElementById("center-label");
            label.style.opacity = "0";
            setTimeout(() => {
                switch (type) {
                    case "rasi": label.textContent = "ராசி"; break;
                    case "d9": label.textContent = "நவம்சம் (D9)"; break;
                    case "d10": label.textContent = "தசம்சம் (D10)"; break;
                    case "d7": label.textContent = "ஸப்தம்சம் (D7)"; break;
                }
                label.style.opacity = "1";
            }, 300);
        }

        function saveChart() {
            try {
                const name = document.getElementById("name").value.trim();
                const date = document.getElementById("date").value;
                const time = document.getElementById("time").value;
                const seconds = document.getElementById("seconds").value || 0;

                if (!name || !date || !time) {
                    alert("⚠️ Please fill Name, Date and Time before saving.");
                    return;
                }

                // ✅ Support both datalist input and select (auto-detect)
                const placeInput = document.getElementById("placeSearch") || document.getElementById("place");
                if (!placeInput) {
                    alert("⚠️ Please select or type a valid place before saving.");
                    return;
                }

                const selectedPlace = {
                    city: placeInput.value || "",
                    lat: placeInput.getAttribute("data-lat") || DEFAULT_PLACE.lat,
                    lon: placeInput.getAttribute("data-lon") || DEFAULT_PLACE.lon,
                    tz: placeInput.getAttribute("data-tz") || DEFAULT_PLACE.tz
                };

                const ayanamsa = document.getElementById("ayanamsa").value;
                const chartType = document.getElementById("chartType").value;
                const gender = document.getElementById("gender") ? document.getElementById("gender").value : "";
                const tag = document.getElementById("tag") ? document.getElementById("tag").value : "";
                const comment = document.getElementById("comment") ? document.getElementById("comment").value : "";

                const payload = {
                    name, date, time, seconds,
                    place_json: selectedPlace,
                    ayanamsa, chartType,
                    gender, tag, comment,
                    data_json: window.lastChartData || {}
                };

                console.log("💾 Saving chart →", payload);

                fetch("/save_chart", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                })
                    .then(r => r.json())
                    .then(d => {
                        if (d.status === "ok") {
                            alert("💾 Chart Saved Successfully!");
                        } else {
                            alert("❌ Save failed: " + (d.message || "Unknown error"));
                        }
                    })
                    .catch(err => {
                        console.error("Save error:", err);
                        alert("❌ Error saving chart.");
                    });

            } catch (e) {
                console.error("Unexpected saveChart error:", e);
                alert("❌ Unexpected error while saving chart.");
            }
        }

        // ---------------------------
        // 📂 VIEW / EDIT SAVED CHARTS
        // ---------------------------

        // ====================================================
        // 📂 VIEW / LOAD / EDIT / UPDATE SAVED CHARTS
        // ====================================================

        let currentEditingId = null;  // track which chart we're editing

        function openSavedCharts() {
            fetch("/list_charts")
                .then(r => r.json())
                .then(list => {
                    if (!Array.isArray(list) || list.length === 0) {
                        document.getElementById("savedList").innerHTML =
                            "<p>⚠️ No saved charts found.</p>";
                        document.getElementById("savedModal").style.display = "flex";
                        return;
                    }

                    let html = `
                <table>
                    <tr>
                        <th>ID</th>
                        <th>பெயர்</th>
                        <th>பாலினம்</th>
                        <th>பிறந்த தேதி</th>
                        <th>நேரம்</th>
                        <th>வகை</th>
                        <th>குறிப்பு</th>
                        <th>செயல்கள்</th>
                    </tr>
            `;
                    list.forEach(r => {
                        html += `
                    <tr>
                        <td>${r.id}</td>
                        <td>${r.name || ""}</td>
                        <td>${r.gender || "-"}</td>
                        <td>${r.date || ""}</td>
                        <td>${r.time || ""}</td>
                        <td>${r.tag || "-"}</td>
                        <td>${r.comment || "-"}</td>
                        <td>
                            <button onclick="loadSavedChart(${r.id})">📄 Load</button>
                            <button onclick="editSavedChart(${r.id})">✏️ Edit</button>
                            <button onclick="deleteSavedChart(${r.id})">🗑️ Delete</button>
                        </td>
                    </tr>
                `;
                    });
                    html += "</table>";
                    document.getElementById("savedList").innerHTML = html;
                    document.getElementById("savedModal").style.display = "flex";
                })
                .catch(err => {
                    console.error("Error loading saved charts:", err);
                    alert("❌ Could not load saved charts.");
                });
        }

        // ✅ Load chart into the input fields and regenerate chart
        function loadSavedChart(cid) {
            fetch(`/get_chart/${cid}`)
                .then(r => r.json())
                .then(res => {
                    if (res.status !== "ok" || !res.chart) {
                        alert("Chart not found.");
                        return;
                    }

                    const chart = res.chart;
                    currentEditingId = chart.id;

                    console.log("✅ Loaded chart from backend:", chart);

                    // Fill fields
                    document.getElementById("name").value = chart.name || "";
                    document.getElementById("date").value = chart.date || "";
                    document.getElementById("time").value = chart.time || "";
                    if (chart.gender) document.getElementById("gender").value = chart.gender;
                    if (chart.tag) document.getElementById("tag").value = chart.tag;
                    if (chart.comment) document.getElementById("comment").value = chart.comment;

                    // Restore place
                    const pj = chart.place_json || {};
                    const placeField = document.getElementById("placeSearch") || document.getElementById("place");
                    if (placeField) {
                        placeField.value = pj.city || "";
                        placeField.setAttribute("data-lat", pj.lat || DEFAULT_PLACE.lat);
                        placeField.setAttribute("data-lon", pj.lon || DEFAULT_PLACE.lon);
                        placeField.setAttribute("data-tz", pj.tz || DEFAULT_PLACE.tz);
                    }

                    // Store chart data in global variable for regeneration
                    window.lastChartData = chart.data_json || {};

                    // Regenerate immediately
                    generateChart();

                    closeModal("savedModal");
                    alert(`✅ Loaded chart #${chart.id} (${chart.name}) for editing.`);
                })
                .catch(err => {
                    console.error("Error loading chart:", err);
                    alert("❌ Failed to load chart.");
                });
        }


        // ✅ Edit button simply loads the chart for full on-screen editing
        function editSavedChart(cid) {
            loadSavedChart(cid);
        }

        // ✅ Save will auto-detect whether we are editing or creating new
        function saveChart() {
            try {
                const name = document.getElementById("name").value.trim();
                const date = document.getElementById("date").value;
                const time = document.getElementById("time").value;
                const seconds = document.getElementById("seconds").value || 0;

                if (!name || !date || !time) {
                    alert("⚠️ Please fill Name, Date and Time before saving.");
                    return;
                }

                const placeInput = document.getElementById("placeSearch") || document.getElementById("place");
                if (!placeInput) {
                    alert("⚠️ Please select or type a valid place before saving.");
                    return;
                }

                const selectedPlace = {
                    city: placeInput.value || "",
                    lat: placeInput.getAttribute("data-lat") || DEFAULT_PLACE.lat,
                    lon: placeInput.getAttribute("data-lon") || DEFAULT_PLACE.lon,
                    tz: placeInput.getAttribute("data-tz") || DEFAULT_PLACE.tz
                };

                const ayanamsa = document.getElementById("ayanamsa").value;
                const chartType = document.getElementById("chartType").value;
                const gender = document.getElementById("gender") ? document.getElementById("gender").value : "";
                const tag = document.getElementById("tag") ? document.getElementById("tag").value : "";
                const comment = document.getElementById("comment") ? document.getElementById("comment").value : "";

                const payload = {
                    id: currentEditingId || null,
                    name, date, time, seconds,
                    place_json: selectedPlace,
                    ayanamsa, chartType,
                    gender, tag, comment,
                    data_json: window.lastChartData || {}
                };

                console.log("💾 Saving chart (create/update) →", payload);

                const endpoint = currentEditingId ? "/update_chart_full" : "/save_chart";

                fetch(endpoint, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                })
                    .then(r => r.json())
                    .then(d => {
                        if (d.status === "ok") {
                            alert(currentEditingId ? "✅ Chart Updated Successfully!" : "💾 Chart Saved Successfully!");
                            currentEditingId = null; // reset after update
                        } else {
                            alert("❌ Save failed: " + (d.message || "Unknown error"));
                        }
                    })
                    .catch(err => {
                        console.error("Save error:", err);
                        alert("❌ Error saving chart.");
                    });

            } catch (e) {
                console.error("Unexpected saveChart error:", e);
                alert("❌ Unexpected error while saving chart.");
            }
        }

        // 🗑️ Delete chart
        function deleteSavedChart(cid) {
            if (!confirm("Are you sure you want to delete this chart?")) return;
            fetch(`/delete_chart/${cid}`, { method: "POST" })
                .then(r => r.json())
                .then(d => {
                    if (d.status === "ok") {
                        alert("🗑️ Deleted successfully.");
                        openSavedCharts();
                    } else {
                        alert("❌ Delete failed.");
                    }
                });
        }


        function addPlace() { /* ... */ }
        function closeModal(id) {
            document.getElementById(id).style.display = "none";
        }
    </script>

</body>
</html>


